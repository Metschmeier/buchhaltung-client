<h2>Alle Buchungen</h2>
<button mat-raised-button color="primary" (click)="exportCsv()">üì• Als CSV exportieren</button>

<table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 full-width-table">

  <!-- Datum -->
  <ng-container matColumnDef="datum">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Datum</th>
    <td mat-cell *matCellDef="let b">{{ b.datum | date }}</td>
  </ng-container>

  <!-- Typ -->
  <ng-container matColumnDef="typ">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Typ</th>
    <td mat-cell *matCellDef="let b">{{ b.typ }}</td>
  </ng-container>

  <!-- Beschreibung -->
  <ng-container matColumnDef="beschreibung">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Beschreibung</th>
    <td mat-cell *matCellDef="let b">{{ b.beschreibung }}</td>
  </ng-container>

  <!-- Betrag Netto -->
  <ng-container matColumnDef="betragNetto">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Betrag Netto</th>
    <td mat-cell *matCellDef="let b">{{ b.betragNetto | currency:'EUR':'symbol':'1.2-2' }}</td>
  </ng-container>

  <!-- Partner -->
  <ng-container matColumnDef="partner">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Partner</th>
    <td mat-cell *matCellDef="let b">{{ getPartnerName(b.partnerId) }}</td>
  </ng-container>

  <!-- Kategorie -->
  <ng-container matColumnDef="kategorie">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Kategorie</th>
    <td mat-cell *matCellDef="let b">{{ getKategorieName(b.kategorieId) }}</td>
  </ng-container>

  <!-- Kostenstelle -->
  <ng-container matColumnDef="kostenstelle">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Kostenstelle</th>
    <td mat-cell *matCellDef="let b">{{ getKostenstelleName(b.kostenstelleId) }}</td>
  </ng-container>

  <!-- Steuersatz -->
  <ng-container matColumnDef="steuersatz">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Steuersatz</th>
    <td mat-cell *matCellDef="let b">{{ getSteuersatzBezeichnung(b.steuersatzId) }}</td>
  </ng-container>

  <!-- Aktionen -->
  <ng-container matColumnDef="aktionen">
    <th mat-header-cell *matHeaderCellDef>Aktionen</th>
    <td mat-cell *matCellDef="let b">
      <button mat-icon-button color="primary" (click)="editBuchung(b)">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button color="warn" (click)="deleteBuchung(b.id)" [disabled]="b.locked">
        <mat-icon>delete</mat-icon>
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
</table>

<mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>

<hr />

<form [formGroup]="form" (ngSubmit)="saveBuchung()" class="buchung-form">

  <label>
    Datum:
    <input type="date" formControlName="datum" />
    @if (form.controls.datum.invalid && form.controls.datum.touched) {
      <span>Datum ist erforderlich.</span>
    }
  </label><br />

  <label>
    Typ:
    <input formControlName="typ" />
    @if (form.controls.typ.invalid && form.controls.typ.touched) {
      <span>Typ ist erforderlich.</span>
    }
  </label><br />

  <label>
    Beschreibung:
    <input formControlName="beschreibung" />
    @if (form.controls.beschreibung.invalid && form.controls.beschreibung.touched) {
      <span>Beschreibung ist erforderlich.</span>
    }
  </label><br />

  <label>
    Betrag netto:
    <input type="number" formControlName="betragNetto" step="0.01" />
    @if (form.controls.betragNetto.invalid && form.controls.betragNetto.touched) {
      <span>Bitte einen positiven Betrag eingeben.</span>
    }
  </label><br />

  <label>
    Partner:
    <select formControlName="partnerId">
      <option value="">Bitte w√§hlen</option>
      @for (p of partners(); track p.id) {
        <option [value]="p.id">{{ p.name }}</option>
      }
    </select>
    @if (form.controls.partnerId.invalid && form.controls.partnerId.touched) {
      <span>Partner ist erforderlich.</span>
    }
  </label><br />

  <label>
    Kategorie:
    <select formControlName="kategorieId">
      <option value="">Bitte w√§hlen</option>
      @for (k of kategorien(); track k.id) {
        <option [value]="k.id">{{ k.kategorie }}</option>
      }
    </select>
    @if (form.controls.kategorieId.invalid && form.controls.kategorieId.touched) {
      <span>Kategorie ist erforderlich.</span>
    }
  </label><br />

  <label>
    Kostenstelle:
    <select formControlName="kostenstelleId">
      <option value="">Bitte w√§hlen</option>
      @for (ks of kostenstellen(); track ks.id) {
        <option [value]="ks.id">{{ ks.kostenstelle }}</option>
      }
    </select>
    @if (form.controls.kostenstelleId.invalid && form.controls.kostenstelleId.touched) {
      <span>Kostenstelle ist erforderlich.</span>
    }
  </label><br />

  <label>
    Steuersatz:
    <select formControlName="steuersatzId">
      <option value="">Bitte w√§hlen</option>
      @for (st of steuersaetze(); track st.id) {
        <option [value]="st.id">{{ st.bezeichnung }} ({{ st.prozentsatz }}%)</option>
      }
    </select>
    @if (form.controls.steuersatzId.invalid && form.controls.steuersatzId.touched) {
      <span>Steuersatz ist erforderlich.</span>
    }
  </label><br />

  <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">Speichern</button>
  <button mat-stroked-button type="button" (click)="form.reset()">Abbrechen</button>
</form>
